<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>player</title>
    <link href="https://cdn.bootcss.com/normalize/7.0.0/normalize.css" rel="stylesheet">
    <link rel="stylesheet" href="./styles/video.css">
    <style>
    </style>
</head>
<body>

<!--svg test -->


<div class="video" id="video-wrap">
    <!--video-background-->
    <div class="" id="fullscreen-wrap">
    <div class="video-foreground">
    <video src="http://vjs.zencdn.net/v/oceans.mp4"   id="video"></video>
    <section class="control">
        <div class="progress" id="progress-wrap">
            <div class="buffered-progress" id="buffered-progress">
                <div class="inner" id="video-progress-inner">
                    <div class="point" id="progress-point" ></div>
                </div>
            </div>
        </div>
        <div class="btns">
            <ul>
                <!--player button-->
                <div class="control-left">
                    <li>
                        <div class="player-btn">
                            <button class="button js-button">
                                <svg width="100%" height="100%" viewBox="0 0 36 36" id="svgicon">
                                    <defs>
                                        <path id="pause-icon" data-state="playing"
                                              d="M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26"/>
                                        <path id="play-icon" data-state="paused"
                                              d="M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28"/>
                                    </defs>
                                    <use xlink:href="#play-icon"/>
                                </svg>
                            </button>
                        </div>
                    </li>
                    <li>

                        <button class="next-btn">
                            <svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%">
                                <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                     xlink:href="#ytp-id-12"></use>
                                <path class="ytp-svg-fill" d="M 12,24 20.5,18 12,12 V 24 z M 22,12 v 12 h 2 V 12 h -2 z"
                                      id="ytp-id-12"></path>
                            </svg>
                        </button>

                    </li>
                    <li>
                        <div class="volume-btn">
                            <button class="volume">
                                <svg width="100%" height="100%" id="svg-volume" viewBox="0 0 36 36">
                                    <defs>
                                        <path class="ytp-svg-fill" id="icon-volume" data-state="mute" d="m 21.48,17.98 c 0,-1.77 -1.02,-3.29 -2.5,-4.03 v 2.21 l 2.45,2.45 c .03,-0.2 .05,-0.41 .05,-0.63 z m 2.5,0 c 0,.94 -0.2,1.82 -0.54,2.64 l 1.51,1.51 c .66,-1.24 1.03,-2.65 1.03,-4.15 0,-4.28 -2.99,-7.86 -7,-8.76 v 2.05 c 2.89,.86 5,3.54 5,6.71 z M 9.25,8.98 l -1.27,1.26 4.72,4.73 H 7.98 v 6 H 11.98 l 5,5 v -6.73 l 4.25,4.25 c -0.67,.52 -1.42,.93 -2.25,1.18 v 2.06 c 1.38,-0.31 2.63,-0.95 3.69,-1.81 l 2.04,2.05 1.27,-1.27 -9,-9 -7.72,-7.72 z m 7.72,.99 -2.09,2.08 2.09,2.09 V 9.98 z" id="ytp-id-122"></path>
                                        <path class="ytp-svg-fill ytp-svg-volume-animation-speaker" id="icon-volume-med" data-state="med" d="M8,21 L12,21 L17,26 L17,10 L12,15 L8,15 L8,21 Z M19,14 L19,22 C20.48,21.32 21.5,19.77 21.5,18 C21.5,16.26 20.48,14.74 19,14 Z" fill="#fff" ></path>
                                    </defs>
                                    <use xlink:href="#icon-volume-med"/>
                                </svg>
                            </button>
                        </div>
                    </li>
                    <li class="volume-control">
                       <div class="volume-out">
                           <div class="volume-inner">
                               <div class="volume-point"></div>
                           </div>
                       </div>
                    </li>
                    <li class="video-time">
                        <span id="video-current-time">0:20</span>
                        <span>/</span>
                        <span id="video-duration"></span>
                    </li>
                </div>
                <li class="setting-wrap">
                    <button class="setting-btn" id="setting-btn" data-state="close">
                        <svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%">
                            <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                 xlink:href="#ytp-id-18"></use>
                            <path d="m 23.94,18.78 c .03,-0.25 .05,-0.51 .05,-0.78 0,-0.27 -0.02,-0.52 -0.05,-0.78 l 1.68,-1.32 c .15,-0.12 .19,-0.33 .09,-0.51 l -1.6,-2.76 c -0.09,-0.17 -0.31,-0.24 -0.48,-0.17 l -1.99,.8 c -0.41,-0.32 -0.86,-0.58 -1.35,-0.78 l -0.30,-2.12 c -0.02,-0.19 -0.19,-0.33 -0.39,-0.33 l -3.2,0 c -0.2,0 -0.36,.14 -0.39,.33 l -0.30,2.12 c -0.48,.2 -0.93,.47 -1.35,.78 l -1.99,-0.8 c -0.18,-0.07 -0.39,0 -0.48,.17 l -1.6,2.76 c -0.10,.17 -0.05,.39 .09,.51 l 1.68,1.32 c -0.03,.25 -0.05,.52 -0.05,.78 0,.26 .02,.52 .05,.78 l -1.68,1.32 c -0.15,.12 -0.19,.33 -0.09,.51 l 1.6,2.76 c .09,.17 .31,.24 .48,.17 l 1.99,-0.8 c .41,.32 .86,.58 1.35,.78 l .30,2.12 c .02,.19 .19,.33 .39,.33 l 3.2,0 c .2,0 .36,-0.14 .39,-0.33 l .30,-2.12 c .48,-0.2 .93,-0.47 1.35,-0.78 l 1.99,.8 c .18,.07 .39,0 .48,-0.17 l 1.6,-2.76 c .09,-0.17 .05,-0.39 -0.09,-0.51 l -1.68,-1.32 0,0 z m -5.94,2.01 c -1.54,0 -2.8,-1.25 -2.8,-2.8 0,-1.54 1.25,-2.8 2.8,-2.8 1.54,0 2.8,1.25 2.8,2.8 0,1.54 -1.25,2.8 -2.8,2.8 l 0,0 z"
                                  fill="#fff" id="ytp-id-18"></path>
                        </svg>
                    </button>
                    <div class="menu">
                        <section class="setting-menu" id="setting-menu">
                            <div id="speed-parent-menu">
                                <p> speed </p>
                                <p> normal <i> > </i> </p>
                            </div>
                        </section>

                        <section class="speed-menu" id="speed-menu">
                            <p id="back-setting-parent"> < 返回</p>
                            <p class="speed-value"> 0.25 </p>
                            <p class="speed-value"> 0.5  </p>
                            <p class="speed-value"> 0.75 </p>
                            <p class="speed-value"> normal </p>
                            <p class="speed-value"> 1.25 </p>
                            <p class="speed-value"> 1.5 </p>
                            <p class="speed-value"> 1.75 </p>
                        </section>

                    </div>

                </li>
                <li>
                    <button class="movie-btn" id="theater-btn">
                        <svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%">
                            <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                 xlink:href="#ytp-id-28"></use>
                            <path d="m 28,11 0,14 -20,0 0,-14 z m -18,2 16,0 0,10 -16,0 0,-10 z" fill="#fff"
                                  fill-rule="evenodd" id="ytp-id-28"></path>
                        </svg>
                    </button>

                </li>
                <li>
                    <button class="fullscreen" id="full-screen">
                        <svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%" fill="#fff">
                            <g class="ytp-fullscreen-button-corner-0">
                                <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                     xlink:href="#ytp-id-77"></use>
                                <path class="ytp-svg-fill" d="m 10,16 2,0 0,-4 4,0 0,-2 L 10,10 l 0,6 0,0 z"
                                      id="ytp-id-77"></path>
                            </g>
                            <g class="ytp-fullscreen-button-corner-1">
                                <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                     xlink:href="#ytp-id-78"></use>
                                <path class="ytp-svg-fill" d="m 20,10 0,2 4,0 0,4 2,0 L 26,10 l -6,0 0,0 z"
                                      id="ytp-id-78"></path>
                            </g>
                            <g class="ytp-fullscreen-button-corner-2">
                                <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                     xlink:href="#ytp-id-79"></use>
                                <path class="ytp-svg-fill" d="m 24,24 -4,0 0,2 L 26,26 l 0,-6 -2,0 0,4 0,0 z"
                                      id="ytp-id-79"></path>
                            </g>
                            <g class="ytp-fullscreen-button-corner-3">
                                <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                     xlink:href="#ytp-id-80"></use>
                                <path class="ytp-svg-fill" d="M 12,20 10,20 10,26 l 6,0 0,-2 -4,0 0,-4 0,0 z"
                                      id="ytp-id-80"></path>
                            </g>
                        </svg>
                    </button>
                </li>
            </ul>
        </div>
    </section>
    </div>
    </div>
</div>
</section>

<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.js"></script>

<script>

    //rebuild
    let log_config = {
        num: 0,
        debug: false
    }

    // in method better not deal global|out data
    // todo:// provide dash interface, implement same method to use this video player
    // todo:// ads insert
//    import log_config  from './config/yPlayer_config'
    class Util {
        getDom(id) {
            if(id.includes('.')) {
                return document.getElementsByClassName(id.substring(1))
            }
            return document.getElementById(id)
        }

        log(str) {
            log_config.debug && console.log(`${log_config.num++}：videoPlayer--->`, str)
        }

        i (str) {
            log_config.debug && console.log(`${log_config.num++} special: ${'-'.repeat(10)}> str`)
        }

        generateDom () {
            return new Proxy({}, {
                get(target, property) {
                    return function(attrs = {}, ...children) {
                        const el = document.createElement(property);
                        for (let prop of Object.keys(attrs)) {
                            el.setAttribute(prop, attrs[prop]);
                        }
                        for (let child of children) {
                            if (typeof child === 'string') {
                                child = document.createTextNode(child);
                            }
                            el.appendChild(child);
                        }
                        return el;
                    }
                }
            });
        }
        addChildren (cur, target) {
           target.appendChild(cur)
        }
    }

    let util = new Util();

    class Controller {

        constructor(video) {
            this.video = video
            this.video_info = {
                duration: '',
                currentTime: '',
                volume: '',
                speed: '',
                buffered: ''
            }
            this.listen_type = {
                canplay: 'canplay',
                play: 'play',
                playing: 'playing',
                timeupdate: 'timeupdate'
            }
            this.doms = {
                ui_progress_wrap: util.getDom('progress-wrap'),
                ui_progress_point: util.getDom('progress-point'),
                ui_buffered: util.getDom('buffered-progress'),
                ui_duration: util.getDom('video-duration'),
                ui_progress: util.getDom('video-progress-inner'),
                ui_fullScreen: util.getDom('full-screen'),
                ui_video_current_time: util.getDom('video-current-time'),
                ui_video_setting: util.getDom('setting-btn'),
                ui_video_setting_menu: util.getDom('setting-menu'),
                ui_video_speed_menu: util.getDom('speed-menu'),
                ui_video_speed_parent_menu: util.getDom('speed-parent-menu'),
                ui_speed_array: [...util.getDom('.speed-value')],
                ui_back_setting: util.getDom('back-setting-parent'),
                ui_theater_btn: util.getDom('theater-btn'),
                ui_video_wrap: util.getDom('video-wrap')
            }
        }

        // entry method
        init() {
            this.listen()
            this.proxy_video_info = this.proxy_render_to_view()
            this.init_event()
        }

        sync_video_info(video_info = this.video_info) {
            video_info.currentTime = this.video.currentTime
            video_info.volume = this.video.volume
            video_info.buffered = this.video.buffered.end(0)
        }

        listen() {
            this.video.addEventListener(this.listen_type.canplay, () => {
                this.proxy_video_info.duration = this.video.duration
                util.log('video-canplay-now')
            })
            this.video.addEventListener(this.listen_type.play, () => {
                this.sync_and_log({
                    event_name: this.listen_type.play
                })
                this.video_info.duration = this.video.duration
                util.log(`ready! video duration is ---->${this.video.duration}`)
            })
            this.video.addEventListener(this.listen_type.playing, () => {
                this.sync_and_log({
                    event_name: this.listen_type.timeupdate
                })
            })
            this.video.addEventListener(this.listen_type.timeupdate, () => {
                util.log('video-play-time-change-now')
                this.sync_and_log({
                    event_name: this.listen_type.timeupdate,
                    proxy: this.proxy_video_info
                })
            })
        }

        sync_and_log({event_name, proxy}) {
            util.log(event_name)
            this.sync_video_info(proxy)
            this.print_video_info()
        }

        // print cat video info
        print_video_info() {
            Object.keys(this.video_info).forEach(item => {
                util.log(this.video_info[item])
            })
        }

        // The video attribute is delegated to the following method, bind data - view
        proxy_render_to_view() {


            let progress_wrap_width = this.doms.ui_progress_wrap.clientWidth
            util.log(`get progress wrap width is ----> ${progress_wrap_width}`)
            return new Proxy(this.video_info, {
                set: (target, key, value, receiver) => {
                    util.log(`ui ----> setting ---> ${key}`)
                    if (Object.is('currentTime', key)) {
                        // 这里可以使用函数式编程, 进度宽度 = 进度宽度/总进度  * 当前事件/总时间
                        this.doms.ui_progress.style.width = this.doms.ui_progress_point.style.left = `${this.cal_current_progress_buffered_width(value, this.video_info.duration, progress_wrap_width)()}px`
                        this.doms.ui_buffered.style.width = `${this.cal_current_progress_buffered_width(this.video_info.buffered, this.video_info.duration, progress_wrap_width)()}px`
                        this.doms.ui_video_current_time.innerHTML = this.format_duration(value.toFixed(0))
                    } if (Object.is('duration', key)) {
                         this.doms.ui_duration.innerHTML = this.format_duration(value.toFixed(0))
                         // set yellow point
                        let pos = progress_wrap_width/4
                        this.add_yellow_point(
                            pos,
                            2*pos,
                            3*pos
                        )
                    }
                    return Reflect.set(target, key, value, receiver);
                }
            });
        }

        cal_current_progress_buffered_width(current_time, duration, wrap_with) {
            return function () {
                return current_time / duration * wrap_with
            }
        }

        format_duration (duration) {
            let sec_num = parseInt(duration, 10); // don't forget the second param
            let hours   = Math.floor(sec_num / 3600);
            let minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            let seconds = sec_num - (hours * 3600) - (minutes * 60);
            if (hours   < 10) {hours   = "0"+hours;}
            if (minutes < 10) {minutes = "0"+minutes;}
            if (seconds < 10) {seconds = "0"+seconds;}
            return hours+':'+minutes+':'+seconds;
        }

        generate_yellow_point (pos) {
          let dom = util.generateDom();
          return dom.div({
              class: 'yellow-point',
              style: `left:${pos}px`
          })
        }

        add_yellow_point (...rest) {
            rest.forEach( item => {
                util.i(item)
                let yellow_dom = this.generate_yellow_point(item)
                util.addChildren(yellow_dom, this.doms.ui_progress)
            })
        }

        init_event () {
            // todo:// add event init Dom like android
            this.bind_event(this.doms.ui_fullScreen, 'click', () => {
                this.full_screen()
            })
            let drag = false
            this.bind_event(this.doms.ui_progress_wrap, 'mousedown', (e) => {
                drag = true;
                this.video.pause()
                console.log('mouse donw 事件执行')
                    this.update_progress_after_drag(e.pageX);

            })
                $(document).mouseup( (e) => {
                     if(drag) {
                        drag = false;
                        this.video.pause()
                             this.update_progress_after_drag(e.pageX);
                        console.log('mouse up 事件执行')
                     }
                })

            $(document).mousemove( (e) => {
                console.log('---------------------------mouser over事件执行')
                if(drag) {
                        this.update_progress_after_drag(e.pageX);
                }
            })

            this.bind_event(this.doms.ui_video_speed_parent_menu, 'click', (e) => {
                this.doms.ui_video_speed_menu.style.display = 'block'
                this.hide_setting_menu()
            })

            this.bind_event(this.doms.ui_video_setting,'click', (e) => {
                let dom = e.currentTarget
                var state = dom.dataset.state;
                if (Object.is('open', state)) {
                    this.hide_setting_menu()
                } else {
                    this.show_setting_menu()
                    if (this.equal('block', this.get_display_state(this.doms.ui_video_speed_menu))){
                        this.hide_speed_menu()
                    }
                }
            })

            this.doms.ui_speed_array.forEach( item => {
                this.bind_event(item, 'click', e => {
                    let speed = e.currentTarget.innerHTML
                    speed = this.equal('normal', speed) ? 1 : speed
                    if (Number.isInteger(parseInt(speed))) {
                         this.video.playbackRate = speed
                         this.hide_speed_menu()
                    } else {
                        throw new Error ('speed is need number')
                    }

                })
            })

            this.bind_event(this.doms.ui_back_setting, 'click', e => {
                this.hide_speed_menu()
                this.show_setting_menu()
            })

            this.bind_event(this.doms.ui_theater_btn, 'click', e => {
                this.toggle_theater()
            })

        }

        toggle_theater () {
            if (this.doms.ui_video_wrap.style.width === '100%'){
                this.doms.ui_video_wrap.style.width = '70%'
            } else {
                this.doms.ui_video_wrap.style.width = '100%'
            }

        }

        equal (el1, el2) {
            if (typeof el1 === 'string') {
                el1 = this.format_str(el1)
            }
            if (typeof el2 === 'string') {
                el2 = this.format_str(el2)
            }
           return Object.is(el1, el2)
        }

        format_str (str) {
           return str.replace(/^\s+|\s+$/g,"");
        }

        get_display_state (ele) {
           return ele.style.display
        }

        hide_setting_menu () {
            this.doms.ui_video_setting_menu.style.display = 'none'
            this.doms.ui_video_setting.dataset.state = 'close'
            this.doms.ui_video_setting.style.transform = 'rotate(30deg)'
        }

        show_setting_menu () {
            this.doms.ui_video_setting_menu.style.display = 'block'
            this.doms.ui_video_setting.dataset.state = 'open'
            this.doms.ui_video_setting.style.transform = 'rotate(0deg)'
        }

        hide_speed_menu () {
            this.doms.ui_video_speed_menu.style.display = 'none'
        }

        show_speed_menu () {
            this.doms.ui_video_speed_menu.style.display = 'block'
        }

        update_progress_after_drag (x) {
            // - process.offset.left
            let position = x - $('#progress-point').offset().left
            console.log('------------','mouse position is ------->'+x, 'point offset screen left is '+this.get_offset_left(this.doms.ui_progress_point), 'pageX change distance is -->'+position)
//            var percentage = 100 * position / this.doms.ui_progress_wrap.style.width;
//            if(percentage > 100) {
//                percentage = 100;
//            }
//            if(percentage < 0) {
//                percentage = 0;
//            }
            // set progress postion
                this.doms.ui_progress_point.style.left = this.doms.ui_progress.style.width = position + parseInt(this.doms.ui_progress.style.width) + 'px'
            // todo:// 此时 wrap width 为 null? !!!! witdth 与 client width 耗时并不是没有理由的 你对 config 原生 dom 这些属性 不熟悉！
                console.log('after drag postion is ------->', this.doms.ui_progress.clientWidth, this.doms.ui_progress_point.style.left)
                console.log('currentTime', parseInt(this.doms.ui_progress.style.width), this.doms.ui_progress_wrap.clientWidth, this.video_info.duration)
                this.video.currentTime = parseInt(this.doms.ui_progress.style.width) / parseInt(this.doms.ui_progress_wrap.clientWidth) * this.video_info.duration
            // todo:// this.doms.ui_video_current_time =

        }

        get_offset_left(e){
            var offset=parseInt(e.offsetLeft)
            if(e.offsetParent!=null) offset+=this.get_offset_left(e.offsetParent);
            util.i(offset)
            return offset;
        }

        full_screen (elem = this.video) {
            let btn_fullscreen = util.getDom('fullscreen-wrap')
            if (btn_fullscreen.classList.contains('video-background')) {
              btn_fullscreen.classList.remove('video-background')
            } else {
              btn_fullscreen.classList.add('video-background')
            }
        }

        bind_event(target, type, callBack){
           target.addEventListener(type, function (e) {
               callBack(e)
           })
        }
    }

    let video = util.getDom('video')
    //todo:// set play speed
    video.playbackRate = 2
    // todo:// set video lock
    let video_obj = new Controller(video)
    video_obj.init()

    // recalculate window
    window.addEventListener('resize', function () {
        video_obj.init()
    })


</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min.js "></script>

<script>
    // todo:// frame this init animate
    var playButton = {
        el: document.querySelector(".js-button"),
        iconEls: {
            playing: document.querySelector("#pause-icon"),
            paused: document.querySelector("#play-icon")
        },
        nextState: {
            playing: "paused",
            paused: "playing"
        },
        init: function () {
            this.setInitialState();
            this.replaceUseEl();
            this.el.addEventListener("click", this.toggle.bind(this));
        },
        setInitialState: function () {
            var initialIconRef = this.el.querySelector("use").getAttribute("xlink:href");
            this.state = this.el.querySelector(initialIconRef).getAttribute("data-state");

        },
        replaceUseEl: function () {
            var path = Snap("#svgicon").paper.path();
            $(".js-button").find("use").remove();
            Snap("#svgicon").append(path);
            path.attr("class", "js-icon").attr("d", this.stateIconPath());
        },
        toggle: function () {
            var path = Snap.select('.js-icon');
            this.goToNextState()
            path.animate({
                d: this.stateIconPath()
            }, 100, mina.linear);
        },
        goToNextState: function () {
            this.state = this.nextState[this.state];
            //todo :// method rebuild video obj use
            if (this.state === this.nextState.playing) {
               video.pause()
            } else {
                video.play()
            }

        },
        stateIconPath: function () {
            return this.iconEls[this.state].getAttribute("d");
        }

    };
    playButton.init();
</script>

<script>

    var playButton1 = {
        el: document.querySelector(".volume"),
        iconEls: {
            mute: document.querySelector("#icon-volume"),
            med: document.querySelector("#icon-volume-med")
        },
        nextState: {
            mute: "med",
            med: "mute"
        },
        init: function () {
            this.setInitialState();
            this.replaceUseEl();
            this.el.addEventListener("click", this.toggle.bind(this));
        },
        setInitialState: function () {
            var initialIconRef = this.el.querySelector("use").getAttribute("xlink:href");
            this.state = this.el.querySelector(initialIconRef).getAttribute("data-state");

        },
        replaceUseEl: function () {
            var path = Snap("#svg-volume").paper.path();
            $(".volume").find("use").remove();
            Snap("#svg-volume").append(path);
            path.attr("class", "js-icon2").attr("d", this.stateIconPath());
        },
        toggle: function () {
            var path = Snap.select('.js-icon2');
            this.goToNextState()
            path.animate({
                d: this.stateIconPath()
            }, 500, mina.linear);
        },
        goToNextState: function () {
            this.state = this.nextState[this.state];
        },
        stateIconPath: function () {
            return this.iconEls[this.state].getAttribute("d");
        }
    };
    playButton1.init();

</script>


</body>
</html>