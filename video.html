<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>player</title>
    <link href="https://cdn.bootcss.com/normalize/7.0.0/normalize.css" rel="stylesheet">
    <link rel="stylesheet" href="./styles/video.css">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <style>
    </style>
    <style type="text/css">
        .icon {
            width: 15px; height: 15px;
            vertical-align: -0.3em;
            fill: #fff;
            overflow: hidden;
        }
        svg{
            fill: #fff;
        }
    </style>
</head>
<body>

<script src="./svg/svg.js"></script>
<!--svg test -->


<div class="video" id="video-wrap">
    <!--video-background-->

    <div class="" id="fullscreen-wrap">
        <div class="ytp-spinner" data-layer="4" style="" id="spinner">
            <div><div class="ytp-spinner-container">
                <div class="ytp-spinner-rotator">
                    <div class="ytp-spinner-left">
                        <div class="ytp-spinner-circle">

                        </div>
                    </div>
                    <div class="ytp-spinner-right">
                        <div class="ytp-spinner-circle">

                        </div>
                    </div>
                </div>
            </div>
            </div>
            <div class="ytp-spinner-message" style="display: none;">If playback doesn't begin shortly, try restarting your device.</div></div>

        <section class="video-status-btn" id="video-status-btn">

            <svg width="100%" height="100%" viewBox="0 0 36 36" fill="#fff" id="play-status">
                <path id="pause-icon" data-state="playing"
                      d="M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26"/>
            </svg>

            <svg width="100%" height="100%" viewBox="0 0 36 36" fill="#fff" id="pause-status">
                <path id="play-icon" data-state="paused"
                      d="M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28"/>
            </svg>

        </section>
    <div class="video-foreground">
        <!--data-dashjs-player-->
     <div id="theater-wrap">
    <video  id="video" >
        <p>Your browser does not support the video tag.</p>
    </video>
         </div>
    <section class="control" id="bottom-control">
        <div class="progress-visual-hover" id="progress-visual-hover">
        <div class="progress" id="progress-wrap" >
            <div class="hover-wrap" id="hover-wrap"></div>
            <div class="buffered-progress" id="buffered-progress">
                <div class="inner" id="video-progress-inner">
                    <div class="point" id="progress-point" ></div>
                </div>
            </div>
        </div>
        </div>
        <div class="btns">
            <ul>
                <!--player button-->
                <div class="control-left" id="control-left">
                    <li>
                        <div class="player-btn">
                            <button class="button js-button">
                                <svg width="100%" height="100%" viewBox="0 0 36 36" id="svgicon">
                                    <defs>
                                        <path id="paused" data-state="playing"
                                              d="M11,10 L17,10 17,26 11,26 M20,10 L26,10 26,26 20,26"/>
                                        <path id="playing" data-state="paused"
                                              d="M11,10 L18,13.74 18,22.28 11,26 M18,13.74 L26,18 26,18 18,22.28"/>
                                    </defs>
                                    <use id="play-btn-use" xlink:href="#paused"/>
                                </svg>
                            </button>
                        </div>
                    </li>
                    <li>

                        <button class="next-btn">
                            <svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%">
                                <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                     xlink:href="#ytp-id-12"></use>
                                <path class="ytp-svg-fill" d="M 12,24 20.5,18 12,12 V 24 z M 22,12 v 12 h 2 V 12 h -2 z"
                                      id="ytp-id-12"></path>
                            </svg>
                        </button>

                    </li>
                    <li>
                        <div class="volume-btn" id="volume-btn">
                            <button class="volume">
                                <svg width="100%" height="100%" id="svg-volume" viewBox="0 0 36 36">
                                    <defs>
                                        <path class="ytp-svg-fill" id="mute" data-state="med" d="m 21.48,17.98 c 0,-1.77 -1.02,-3.29 -2.5,-4.03 v 2.21 l 2.45,2.45 c .03,-0.2 .05,-0.41 .05,-0.63 z m 2.5,0 c 0,.94 -0.2,1.82 -0.54,2.64 l 1.51,1.51 c .66,-1.24 1.03,-2.65 1.03,-4.15 0,-4.28 -2.99,-7.86 -7,-8.76 v 2.05 c 2.89,.86 5,3.54 5,6.71 z M 9.25,8.98 l -1.27,1.26 4.72,4.73 H 7.98 v 6 H 11.98 l 5,5 v -6.73 l 4.25,4.25 c -0.67,.52 -1.42,.93 -2.25,1.18 v 2.06 c 1.38,-0.31 2.63,-0.95 3.69,-1.81 l 2.04,2.05 1.27,-1.27 -9,-9 -7.72,-7.72 z m 7.72,.99 -2.09,2.08 2.09,2.09 V 9.98 z" id="ytp-id-122"></path>
                                        <path class="ytp-svg-fill ytp-svg-volume-animation-speaker" id="med" data-state="mute" d="M8,21 L12,21 L17,26 L17,10 L12,15 L8,15 L8,21 Z M19,14 L19,22 C20.48,21.32 21.5,19.77 21.5,18 C21.5,16.26 20.48,14.74 19,14 Z" fill="#fff" ></path>
                                    </defs>
                                    <use xlink:href="#mute" id="volume-btn-use"/>
                                </svg>
                            </button>
                        </div>
                    </li>
                    <li class="volume-control" id="volume-control">
                       <div class="volume-out" id="volume-out">
                           <div class="volume-inner" id="volume-inner">
                               <div class="volume-point" id="volume-point"></div>
                           </div>
                       </div>
                    </li>
                    <li class="video-time">
                        <span id="video-current-time">0:20</span>
                        <span>/</span>
                        <span id="video-duration"></span>
                    </li>
                </div>
                <li class="setting-wrap">
                    <p class="speed-tag" id="speed-tag">1.0</p>
                    <button class="setting-btn" id="setting-btn" data-state="close">
                        <svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%">
                            <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                 xlink:href="#ytp-id-18"></use>
                            <path d="m 23.94,18.78 c .03,-0.25 .05,-0.51 .05,-0.78 0,-0.27 -0.02,-0.52 -0.05,-0.78 l 1.68,-1.32 c .15,-0.12 .19,-0.33 .09,-0.51 l -1.6,-2.76 c -0.09,-0.17 -0.31,-0.24 -0.48,-0.17 l -1.99,.8 c -0.41,-0.32 -0.86,-0.58 -1.35,-0.78 l -0.30,-2.12 c -0.02,-0.19 -0.19,-0.33 -0.39,-0.33 l -3.2,0 c -0.2,0 -0.36,.14 -0.39,.33 l -0.30,2.12 c -0.48,.2 -0.93,.47 -1.35,.78 l -1.99,-0.8 c -0.18,-0.07 -0.39,0 -0.48,.17 l -1.6,2.76 c -0.10,.17 -0.05,.39 .09,.51 l 1.68,1.32 c -0.03,.25 -0.05,.52 -0.05,.78 0,.26 .02,.52 .05,.78 l -1.68,1.32 c -0.15,.12 -0.19,.33 -0.09,.51 l 1.6,2.76 c .09,.17 .31,.24 .48,.17 l 1.99,-0.8 c .41,.32 .86,.58 1.35,.78 l .30,2.12 c .02,.19 .19,.33 .39,.33 l 3.2,0 c .2,0 .36,-0.14 .39,-0.33 l .30,-2.12 c .48,-0.2 .93,-0.47 1.35,-0.78 l 1.99,.8 c .18,.07 .39,0 .48,-0.17 l 1.6,-2.76 c .09,-0.17 .05,-0.39 -0.09,-0.51 l -1.68,-1.32 0,0 z m -5.94,2.01 c -1.54,0 -2.8,-1.25 -2.8,-2.8 0,-1.54 1.25,-2.8 2.8,-2.8 1.54,0 2.8,1.25 2.8,2.8 0,1.54 -1.25,2.8 -2.8,2.8 l 0,0 z"
                                  fill="#fff" id="ytp-id-18"></path>
                        </svg>
                    </button>
                    <div class="menu">
                        <section class="setting-menu" id="setting-menu">
                            <div id="speed-parent-menu">
                                <p> speed </p>

                                <p> normal </p>
                                <svg class="icon" aria-hidden="true">
                                    <use xlink:href="#icon-fanhui-copy1"></use>
                                </svg>
                            </div>
                        </section>

                        <section class="speed-menu" id="speed-menu">


                            <p id="back-setting-parent">
                                <svg class="icon" aria-hidden="true">
                                    <use xlink:href="#icon-fanhui-copy"></use>
                                </svg>
                                Speed</p>
                            <p class="speed-value"> 0.25 </p>
                            <p class="speed-value"> 0.5  </p>
                            <p class="speed-value"> 0.75 </p>
                            <p class="speed-value"> normal </p>
                            <p class="speed-value"> 1.25 </p>
                            <p class="speed-value"> 1.5 </p>
                            <p class="speed-value"> 1.75 </p>
                        </section>

                    </div>

                </li>
                <li>
                    <button class="movie-btn" id="theater-btn">
                        <svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%">
                            <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                 xlink:href="#ytp-id-28"></use>
                            <path d="m 28,11 0,14 -20,0 0,-14 z m -18,2 16,0 0,10 -16,0 0,-10 z" fill="#fff"
                                  fill-rule="evenodd" id="ytp-id-28"></path>
                        </svg>
                    </button>

                </li>
                <li>
                    <button class="fullscreen" id="full-screen">
                        <svg height="100%" version="1.1" viewBox="0 0 36 36" width="100%" fill="#fff">
                            <g class="ytp-fullscreen-button-corner-0">
                                <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                     xlink:href="#ytp-id-77"></use>
                                <path class="ytp-svg-fill" d="m 10,16 2,0 0,-4 4,0 0,-2 L 10,10 l 0,6 0,0 z"
                                      id="ytp-id-77"></path>
                            </g>
                            <g class="ytp-fullscreen-button-corner-1">
                                <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                     xlink:href="#ytp-id-78"></use>
                                <path class="ytp-svg-fill" d="m 20,10 0,2 4,0 0,4 2,0 L 26,10 l -6,0 0,0 z"
                                      id="ytp-id-78"></path>
                            </g>
                            <g class="ytp-fullscreen-button-corner-2">
                                <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                     xlink:href="#ytp-id-79"></use>
                                <path class="ytp-svg-fill" d="m 24,24 -4,0 0,2 L 26,26 l 0,-6 -2,0 0,4 0,0 z"
                                      id="ytp-id-79"></path>
                            </g>
                            <g class="ytp-fullscreen-button-corner-3">
                                <use class="ytp-svg-shadow" xmlns:xlink="http://www.w3.org/1999/xlink"
                                     xlink:href="#ytp-id-80"></use>
                                <path class="ytp-svg-fill" d="M 12,20 10,20 10,26 l 6,0 0,-2 -4,0 0,-4 0,0 z"
                                      id="ytp-id-80"></path>
                            </g>
                        </svg>
                    </button>
                </li>
            </ul>
        </div>
    </section>
    </div>
    </div>
</div>
</section>

<!--<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.js"></script>-->
<script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>

<script>

    //rebuild
    let log_config = {
        num: 0,
        debug: false
    }

    // in method better not deal global|out data
    // todo:// provide dash interface, implement same method to use this video player
    // todo:// ads insert
//    import log_config  from './config/yPlayer_config'
    class Util {
        getDom(id) {
            if(id.includes('.')) {
                return document.getElementsByClassName(id.substring(1))
            }
            return document.getElementById(id)
        }

        log(str) {
            log_config.debug && console.log(`${log_config.num++}：videoPlayer--->`, str)
        }

        i (str) {
            log_config.debug && console.log(`${log_config.num++} special: ${'-'.repeat(10)}> str`)
        }

        generateDom () {
            return new Proxy({}, {
                get(target, property) {
                    return function(attrs = {}, ...children) {
                        const el = document.createElement(property);
                        for (let prop of Object.keys(attrs)) {
                            el.setAttribute(prop, attrs[prop]);
                        }
                        for (let child of children) {
                            if (typeof child === 'string') {
                                child = document.createTextNode(child);
                            }
                            el.appendChild(child);
                        }
                        return el;
                    }
                }
            });
        }
        addChildren (cur, target) {
           target.appendChild(cur)
        }
    }

    let util = new Util();

    class Controller {

        constructor(video) {
            this.video = video
            this.video_info = {
                duration: '',
                currentTime: '',
                volume: '',
                speed: '',
                buffered: ''
            }
            this.listen_type = {
                canplay: 'canplay',
                play: 'play',
                playing: 'playing',
                timeupdate: 'timeupdate',
                waiting: 'waiting',
            }
            this.keyboard = {
                space: 32,
                esc: 27,
            }
            this.doms = {
                ui_progress_wrap: util.getDom('progress-wrap'),
                ui_progress_point: util.getDom('progress-point'),
                ui_buffered: util.getDom('buffered-progress'),
                ui_duration: util.getDom('video-duration'),
                ui_progress: util.getDom('video-progress-inner'),
                ui_fullScreen: util.getDom('full-screen'),
                ui_video_current_time: util.getDom('video-current-time'),
                ui_video_setting: util.getDom('setting-btn'),
                ui_video_setting_menu: util.getDom('setting-menu'),
                ui_video_speed_menu: util.getDom('speed-menu'),
                ui_video_speed_parent_menu: util.getDom('speed-parent-menu'),
                ui_speed_array: [...util.getDom('.speed-value')],
                ui_back_setting: util.getDom('back-setting-parent'),
                ui_theater_btn: util.getDom('theater-btn'),
                ui_video_wrap: util.getDom('video-wrap'),
                ui_volume_out: util.getDom('volume-out'),
                ui_volume_inner: util.getDom('volume-inner'),
                ui_volume_point: util.getDom('volume-point'),
                ui_volume_control: util.getDom('volume-control'),
                ui_volume_btn: util.getDom('volume-btn'),
                ui_control_left: util.getDom('control-left'),
                ui_hover_wrap: util.getDom('hover-wrap'),
                ui_speed_tag: util.getDom('speed-tag'),
                ui_bottom_control: util.getDom('bottom-control'),
                ui_video_status_pause: util.getDom('video-status-btn'),
                ui_pause_status: util.getDom('pause-status'),
                ui_play_status: util.getDom('play-status'),
                ui_spinner: util.getDom('spinner'),
                ui_theater_wrap: util.getDom('theater-wrap'),
                ui_progress_visual_hover: util.getDom('progress-visual-hover'),
            }
        }

        // entry method
        init() {
            this.listen()
            this.proxy_video_info = this.proxy_render_to_view()
            this.init_event()
            window.onload =  () => {
                this.init_volume()
            }
        }

        in_loading () {
          this.doms.ui_spinner.style.display = 'block'
        }

        after_loading () {
            this.doms.ui_spinner.style.display = 'none'
        }

        /**
         * after video relative size change
         */
        recalcute_dom () {
            this.proxy_video_info = this.proxy_render_to_view()
        }

        init_volume () {
            // todo :// this 50 have issue
            let ui_volume_width = parseInt(this.get_out_css(this.doms.ui_volume_out)['width']) || 50
            this.video.volume = 10 / ui_volume_width
            this.doms.ui_volume_inner.style.width = this.doms.ui_volume_point.style.left = '10px'
        }

        sync_video_info(video_info = this.video_info) {
            video_info.currentTime = this.video.currentTime
            video_info.volume = this.video.volume
            video_info.buffered = this.video.buffered.end(0)
        }

        get_out_css (ele) {
            if(typeof ele.currentStyle!=='undefined') {
                var style = ele.currentStyle
            } else if(typeof window.getComputedStyle!=='undefined') {
                var style = window.getComputedStyle(ele, null);
            }
            return style
        }

        listen() {
            this.video.addEventListener(this.listen_type.canplay, () => {
                this.proxy_video_info.duration = this.video.duration
                this.after_loading()
                util.log('video-canplay-now')
            })


            this.video.addEventListener(this.listen_type.waiting, () => {
                console.log('--------video is loading------')
                this.in_loading()
            })

            this.video.addEventListener(this.listen_type.play, () => {
                this.sync_and_log({
                    event_name: this.listen_type.play
                })
                util.log(`ready! video duration is ---->${this.video.duration}`)
            })
            this.video.addEventListener(this.listen_type.playing, () => {
                this.sync_and_log({
                    event_name: this.listen_type.timeupdate
                })
            })
            this.video.addEventListener(this.listen_type.timeupdate, () => {
                util.log('video-play-time-change-now')
                this.sync_and_log({
                    event_name: this.listen_type.timeupdate,
                    proxy: this.proxy_video_info
                })
            })
        }

        sync_and_log({event_name, proxy}) {
            util.log(event_name)
            this.sync_video_info(proxy)
            this.print_video_info()
        }

        // print cat video info
        print_video_info() {
            Object.keys(this.video_info).forEach(item => {
                util.log(this.video_info[item])
            })
        }

        // The video attribute is delegated to the following method, bind data - view
        proxy_render_to_view() {

            let progress_wrap_width = this.doms.ui_progress_wrap.clientWidth
            util.log(`get progress wrap width is ----> ${progress_wrap_width}`)
            return new Proxy(this.video_info, {
                set: (target, key, value, receiver) => {
                    util.log(`ui ----> setting ---> ${key}`)
                    if (Object.is('currentTime', key)) {
                        // 这里可以使用函数式编程, 进度宽度 = 进度宽度/总进度  * 当前事件/总时间
                        this.doms.ui_progress.style.width = this.doms.ui_progress_point.style.left = `${this.cal_current_progress_buffered_width(value, this.video_info.duration, progress_wrap_width)()}px`
                        this.doms.ui_buffered.style.width = `${this.cal_current_progress_buffered_width(this.video_info.buffered, this.video_info.duration, progress_wrap_width)()}px`
                        this.doms.ui_video_current_time.innerHTML = this.format_duration(value.toFixed(0))
                    } if (Object.is('duration', key)) {
                         this.doms.ui_duration.innerHTML = this.format_duration(value.toFixed(0))
                         // set yellow point
                        let pos = progress_wrap_width/4
                        this.add_yellow_point(
                            pos,
                            2*pos,
                            3*pos
                        )
                    }
                    return Reflect.set(target, key, value, receiver);
                }
            });
        }

        cal_current_progress_buffered_width(current_time, duration, wrap_with) {
            return function () {
                return current_time / duration * wrap_with
            }
        }

        format_duration (duration) {
            let sec_num = parseInt(duration, 10); // don't forget the second param
            let hours   = Math.floor(sec_num / 3600);
            let minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            let seconds = sec_num - (hours * 3600) - (minutes * 60);
            if (hours   < 10) {hours   = "0"+hours;}
            if (minutes < 10) {minutes = "0"+minutes;}
            if (seconds < 10) {seconds = "0"+seconds;}
            return hours+':'+minutes+':'+seconds;
        }

        generate_yellow_point (pos) {
          let dom = util.generateDom();
          return dom.div({
              class: 'yellow-point',
              style: `left:${pos}px`
          })
        }

        add_yellow_point (...rest) {
            rest.forEach( item => {
                util.i(item)
                let yellow_dom = this.generate_yellow_point(item)
                util.addChildren(yellow_dom, this.doms.ui_progress)
            })
        }

        init_event () {
            // todo:// add event init Dom like android
            this.bind_event(this.doms.ui_fullScreen, 'click', () => {
                this.full_screen()
            })

            let drag = false, volume_drag = false
            this.bind_event(this.doms.ui_progress_visual_hover, 'mousedown', (e) => {
                drag = true;
                console.log('mouse donw 事件执行')
                    this.update_progress_after_drag(e.pageX);

            })

            this.bind_event(this.doms.ui_progress_visual_hover, 'mousemove', (e) => {
                // let width = `${e.pageX - $('#hover-wrap').offset().left}px`
                let width = `${e.pageX - this.getDomOffset(this.doms.ui_hover_wrap).left}px`
                this.doms.ui_hover_wrap.style.width = width
            })

            this.bind_event(this.doms.ui_progress_visual_hover, 'mouseover', (e) => {
                let width = `${e.pageX - this.getDomOffset(this.doms.ui_hover_wrap).left}px`
                this.doms.ui_hover_wrap.style.width = width
            })

            this.bind_event(this.doms.ui_progress_visual_hover, 'mouseleave', (e) => {
                this.doms.ui_hover_wrap.style.width = 0
            })

            // set volume event
            this.bind_event(this.doms.ui_volume_out, 'mousedown', e => {
                volume_drag = true
                this.update_volume_drag(e.pageX)
            })

            document.addEventListener('mouseup', (e) => {
                if(drag) {
                    drag = false;
                    this.update_progress_after_drag(e.pageX);
                    util.log('mouse up 事件执行')
                } else if (volume_drag) {
                   // update volume
                    volume_drag = false
                    this.update_volume_drag(e.pageX)
                }
            })

            document.addEventListener('mousemove', (e) => {
                util.log('mousemove 事件执行')
                if(drag) {
                    this.update_progress_after_drag(e.pageX);
                } else if (volume_drag) {
                    this.update_volume_drag(e.pageX)
                }
            })

            this.bind_event(this.doms.ui_video_speed_parent_menu, 'click', (e) => {
                this.show_speed_menu()
                this.hide_setting_menu()
            })

            this.bind_event(this.doms.ui_video_setting,'click', (e) => {
                let dom = e.currentTarget
                var state = dom.dataset.state;
                if (Object.is('open', state)) {
                    this.hide_setting_menu()
                } else {
                    this.show_setting_menu()
                    if (this.equal('block', this.get_display_state(this.doms.ui_video_speed_menu))){
                        this.hide_speed_menu()
                    }
                }
            })

            this.doms.ui_speed_array.forEach( item => {
                this.bind_event(item, 'click', e => {
                    let speed = e.currentTarget.innerHTML
                    speed = this.equal('normal', speed) ? 1 : speed
                    if (Number.isInteger(parseInt(speed))) {
                        this.doms.ui_speed_tag.innerHTML = this.video.playbackRate = speed === 1 ? 1.0 : speed
                         this.hide_speed_menu()
                    } else {
                        throw new Error ('speed is need number')
                    }

                })
            })

            this.bind_event(this.doms.ui_back_setting, 'click', e => {
                this.hide_speed_menu()
                this.show_setting_menu()
            })

            this.bind_event(this.doms.ui_theater_btn, 'click', e => {
                this.toggle_theater()
                this.recalcute_dom()
            })

            this.bind_event(this.doms.ui_volume_btn, 'mouseover', () => {
                this.show_volume_control()
            })

            this.bind_event(this.doms.ui_control_left, 'mouseleave', () => {
                this.hide_volume_control()
            })

            this.bind_event(this.doms.ui_video_wrap, 'mouseover', e => {
               this.show_bottom_control()
            })

            this.bind_event(this.doms.ui_video_wrap, 'mouseleave', e => {
                this.hide_bottom_control()
            })

            this.bind_event(this.video, 'click', e => {
                // this.doms.ui_video_status_pause.style.opacity = 1
                // todo:// should after video can play
                if (this.video.paused) {
                    this.video.play()
                    this.doms.ui_play_status.style.display = 'block'
                }
                else {
                    this.video.pause()
                    this.doms.ui_pause_status.style.display = 'block'
                }
                playButton.toggle()
                this.doms.ui_video_status_pause.style.animation = 'video_status .3s linear'
                setTimeout( () => {
                    this.doms.ui_video_status_pause.style.animation = ''
                    this.doms.ui_play_status.style.display = 'none'
                    this.doms.ui_pause_status.style.display = 'none'
                },400)
            })


            document.addEventListener('keydown', e => {
                let key = e.keyCode
                console.log(key)
                if (key == this.keyboard.space) {
                    playButton.toggle()
                    e.preventDefault()
                }
                else if (key == this.keyboard.esc) {
                    let btn_fullscreen = util.getDom('fullscreen-wrap')
                    if (btn_fullscreen.classList.contains('video-background')) {
                        btn_fullscreen.classList.remove('video-background')
                        this.show_theater_btn()
                        this.recalcute_dom()
                    }
                }
            })

        }

        show_bottom_control () {
            this.doms.ui_bottom_control.style.opacity = 1
        }

        hide_bottom_control () {
            this.doms.ui_bottom_control.style.opacity = 0
        }

        show_volume_control () {
            this.doms.ui_volume_control.style.opacity = 1
            this.doms.ui_volume_control.style.width = '50px'
        }

        hide_volume_control () {
           this.doms.ui_volume_control.style.opacity = 0
           this.doms.ui_volume_control.style.width = '0'
        }

        toggle_theater () {
            if (this.doms.ui_video_wrap.style.width === '100%'){
                this.doms.ui_video_wrap.style.width = '70%'
                this.doms.ui_theater_wrap.style.width = '100%'
                this.doms.ui_theater_btn.style.transform = 'scale(0.8)'
            } else {
                this.doms.ui_video_wrap.style.width = '100%'
                this.doms.ui_theater_wrap.style.width = '90%'
                this.doms.ui_theater_wrap.style.margin = 'auto'
                this.doms.ui_theater_btn.style.transform = 'scale(1)'
            }

        }

        getOffset( el ) {
            var _x = 0;
            var _y = 0;
            while( el && !isNaN( el.offsetLeft ) && !isNaN( el.offsetTop ) ) {
                _x += el.offsetLeft - el.scrollLeft;
                _y += el.offsetTop - el.scrollTop;
                el = el.offsetParent;
            }
            return { top: _y, left: _x };
        }
        getDomOffset (el) {
            el = el.getBoundingClientRect()
            return {
                left: el.left + window.scrollX,
                top: el.top + window.scrollY
            }
        }
        equal (el1, el2) {
            if (typeof el1 === 'string') {
                el1 = this.format_str(el1)
            }
            if (typeof el2 === 'string') {
                el2 = this.format_str(el2)
            }
           return Object.is(el1, el2)
        }

        format_str (str) {
           return str.replace(/^\s+|\s+$/g,"");
        }

        get_display_state (ele) {
           return ele.style.display
        }

        hide_setting_menu () {
            this.doms.ui_video_setting_menu.style.display = 'none'
            this.doms.ui_video_setting.dataset.state = 'close'
            this.doms.ui_video_setting.style.transform = 'rotate(0deg)'
        }

        show_setting_menu () {
            this.doms.ui_video_setting_menu.style.display = 'block'
            this.doms.ui_video_setting.dataset.state = 'open'
            this.doms.ui_video_setting.style.transform = 'rotate(30deg)'
        }

        hide_speed_menu () {
            this.doms.ui_video_speed_menu.style.display = 'none'
        }

        show_speed_menu () {
            this.doms.ui_video_speed_menu.style.display = 'block'
        }

        update_progress_after_drag (x) {
            // - process.offset.left
            // todo:// test
            // let position = x - $('#progress-point').offset().left
            // let position = x - $('#progress-point').offset().left
            let position = x - this.getDomOffset(this.doms.ui_progress_point).left
            // console.log(position, position1)
            // set progress postion
            let progress_wrap_width = parseInt(this.doms.ui_progress_wrap.clientWidth)
            let pos = position + parseInt(this.doms.ui_progress.style.width)
            pos = pos < 0 ? 0 : pos > progress_wrap_width ? progress_wrap_width : pos
            this.doms.ui_progress_point.style.left = this.doms.ui_progress.style.width = `${pos}px`
            // todo:// 此时 wrap width 为 null? !!!! witdth 与 client width 耗时并不是没有理由的 你对 config 原生 dom 这些属性 不熟悉！
            // todo:// 这里用  .style.width ?

                this.video.currentTime = parseInt(this.doms.ui_progress.style.width) / progress_wrap_width * this.video_info.duration
            // todo:// this.doms.ui_video_current_time =

        }

        update_volume_drag (x) {
            // let position = x - $('#volume-point').offset().left
            let position = x - this.getDomOffset(this.doms.ui_volume_point).left
            let pos = position + parseInt(this.doms.ui_volume_inner.clientWidth)
            let volume_out_width = parseInt(this.doms.ui_volume_out.clientWidth)
            console.log(pos)
            pos = pos < 0 ? 0 : pos > volume_out_width ? volume_out_width : pos
             this.doms.ui_volume_point.style.left =  this.doms.ui_volume_inner.style.width =  `${pos}px`
            //  max volume in  { 0 - 1 }
            let volume = parseInt(this.doms.ui_volume_inner.style.width) / volume_out_width
            console.log('volume is ->', volume)
            this.video.volume = volume
            // volume === 0 change svg
            if (volume === 0) {
                volumeButton.goMute()
            } else {
                volumeButton.goMed()
            }

            util.log(this.doms.ui_volume_inner.style.width, this.doms.ui_volume_out.clientWidth)
        }

        hide_theater_btn () {
            this.doms.ui_theater_btn.style.display = 'none'
        }

        show_theater_btn () {
            this.doms.ui_theater_btn.style.display = 'block'
        }

        full_screen (elem = this.video) {
            let btn_fullscreen = util.getDom('fullscreen-wrap')
            if (btn_fullscreen.classList.contains('video-background')) {
                btn_fullscreen.classList.remove('video-background')
                 this.show_theater_btn()
                 this.recalcute_dom()
            } else {
              btn_fullscreen.classList.add('video-background')
                this.hide_theater_btn()
                this.recalcute_dom()
            }
        }

        bind_event(target, type, callBack){
           target.addEventListener(type, function (e) {
               callBack(e)
           })
        }
    }


    // todo:// watch video width


</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min.js "></script>

<script>
    class SvgUtil {
        constructor ({
            video,
            states,
            svgWrapClass,
            useDomId,
            svgId,
            snapAnimation,
        }) {
            // 用一个对象接收岂不更好 如 this.a = {}
            this.video = video
            this.states = states
            this.svgWrapClass = svgWrapClass
            this.svgId = svgId
            this.useDomId = useDomId
            this.snapAnimation = snapAnimation
            this.el = document.querySelector(svgWrapClass)
            this.iconEls = {
                [this.states[0].name]: document.querySelector(`#${this.states[0].name}`),
                [this.states[1].name]: document.querySelector(`#${this.states[1].name}`),
            }
            this.statesObj = {
                [this.states[0].name]: this.states[1].name,
                [this.states[1].name]: this.states[0].name,
            }
        }

        setInitialState () {
            let initIconRef = this.el.querySelector('use').getAttribute("xlink:href")
            this.state = this.el.querySelector(initIconRef).getAttribute("data-state");
        }
        replaceUseEl () {
            let path = Snap(`#${this.svgId}`).paper.path();
            let ele = document.getElementById(this.useDomId)
            ele.parentNode.removeChild(ele);
            Snap(`#${this.svgId}`).append(path);
            path.attr("class", `c_${this.useDomId}`).attr("d", this.getStateIconPath())
        }
        toggle () {
            var path = Snap.select(`.c_${this.useDomId}`);
            this.toNextState()
            path.animate({
                d: this.getStateIconPath(),
            }, this.snapAnimation.time, this.snapAnimation.name);
        }
        toNextState () {
            this.state = this.statesObj[this.state];
            this.states.forEach( item => {
                Object.is(this.state, item.name) && item.callBack.call(this);
            })
        }
        getStateIconPath () {
            return this.iconEls[this.state].getAttribute('d')
        }

        init () {
            init.call(this)
        }
    }

    // private method
    function init () {
        this.setInitialState()
        this.replaceUseEl()
        this.el.addEventListener("click", this.toggle.bind(this));
    }



    class VolumeSvgUtil extends  SvgUtil{
        constructor (param) {
            super(param)
        }
        goMute  () {
            this.state = this.statesObj['med']
            this.animate()
        }
        goMed () {
            this.state = this.statesObj['mute']
            this.animate()
        }
        replaceUseEl () {
            super.replaceUseEl()
            this.path = Snap.select(`.c_${this.useDomId}`);
        }
        animate () {
            this.path.animate({
                d: this.getStateIconPath()
            }, this.snapAnimation.time, this.snapAnimation.name);
        }
    }




</script>

<script>

    var playButton1 = {
        el: document.querySelector(".volume"),
        iconEls: {
            mute: document.querySelector("#icon-volume"),
            med: document.querySelector("#icon-volume-med")
        },
        nextState: {
            mute: "med",
            med: "mute"
        },
        init: function () {
            this.setInitialState();
            this.replaceUseEl();
            this.el.addEventListener("click", this.toggle.bind(this));
        },
        setInitialState: function () {
            var initialIconRef = this.el.querySelector("use").getAttribute("xlink:href");
            this.state = this.el.querySelector(initialIconRef).getAttribute("data-state");

        },
        replaceUseEl: function () {
            var path = Snap("#svg-volume").paper.path();
            // $(".volume").find("use").remove();
            let ele = document.getElementById('volume-btn-use')
            ele.parentNode.removeChild(ele);
            Snap("#svg-volume").append(path);
            path.attr("class", "js-icon2").attr("d", this.stateIconPath());
        },
        toggle: function () {
            var path = Snap.select('.js-icon2');
            this.goToNextState()
            path.animate({
                d: this.stateIconPath()
            }, 500, mina.easein);
        },
        goMute: function () {
            var path = Snap.select('.js-icon2');
            this.state = this.nextState['med']
            path.animate({
                d: this.stateIconPath()
            }, 100, mina.easein);
        },
        goMed: function () {
            var path = Snap.select('.js-icon2');
            this.state = this.nextState['mute']
            path.animate({
                d: this.stateIconPath()
            }, 100, mina.easein);
        },
        goToNextState: function () {
            video_obj.doms.ui_volume_control.style.display = 'block'
            this.state = this.nextState[this.state];
            if (this.state === 'mute') {
               video.volume = 0
               video_obj.doms.ui_volume_inner.style.width = video_obj.doms.ui_volume_point.style.left = 0
            } else {
                video.volume = 10 / video_obj.doms.ui_volume_out.clientWidth
                video_obj.doms.ui_volume_inner.style.width = video_obj.doms.ui_volume_point.style.left = '10px'
            }
        },
        stateIconPath: function () {
            return this.iconEls[this.state].getAttribute("d");
        }
    };
    // playButton1.init();

</script>

<script>

    let videoInstance = document.querySelectorAll(['qplayer']);
    if (videoInstance) {
       // todo:// 执行一系列初始化函数
    } else {

    }

    function useQplayer (video) {
        // todo:// set video lock
        let video_obj = new Controller(video)
        video_obj.init()

        // recalculate window
        window.addEventListener('resize', function () {
            video_obj.recalcute_dom()
        })

        let volumeButton = new VolumeSvgUtil({
            video:video,
            states:[
                {
                    name:'mute',
                    callBack: function(){
                        this.video.volume = 0
                        video_obj.doms.ui_volume_inner.style.width = video_obj.doms.ui_volume_point.style.left = 0
                    }
                },
                {
                    name:'med',
                    callBack: function(){
                        video.volume = 10 / video_obj.doms.ui_volume_out.clientWidth
                        video_obj.doms.ui_volume_inner.style.width = video_obj.doms.ui_volume_point.style.left = '10px'
                    }
                },
            ],
            svgWrapClass: '.volume',
            useDomId: 'volume-btn-use',
            svgId: 'svg-volume',
            snapAnimation: {
                time: 200,
                name: mina.linear
            }
        })
        let playButton = new SvgUtil({
            video:video,
            states:[
                {
                    name:'paused',
                    callBack: function(){
                        this.video.play()
                    }
                },
                {
                    name:'playing',
                    callBack: function(){
                        this.video.pause()
                    }
                },
            ],
            svgWrapClass: '.js-button',
            useDomId: 'play-btn-use',
            svgId: 'svgicon',
            snapAnimation: {
                time: 200,
                name: mina.linear
            }
        })
        playButton.init();
        volumeButton.init();
        window.playButton = playButton
        window.volumeButton = volumeButton
    }


    // entry point
    let QPlayer = {
        init: function(video, src, isDash, qTheme) {
           video.src = src
           if (isDash) {
               video.setAttribute('data-dashjs-player', '')
           }
            qTheme && useQplayer(video) || ''
        }
    }
    let video = util.getDom('video')
    // let videoUrl = "http://9890.vod.myqcloud.com/9890_9c1fa3e2aea011e59fc841df10c92278.f20.mp4"
    let dashSrc = "https://dash.akamaized.net/envivio/EnvivioDash3/manifest.mpd"
    QPlayer.init(video, dashSrc, true, true)


</script>

</body>
</html>